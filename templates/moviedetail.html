{% extends 'base.html' %}
{% load static custom_tags humanize %}
{% block title %}
{{ movie.name }}
{% endblock %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/moviedetail.css' %}">
{% endblock %}

{% block content %}
<div id="moviedetail" class="container">   
    <nav aria-label="breadcrumb" class="m-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'movielist' %}">Films</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ movie.name }}</li>
        </ol>
    </nav> 
    <div id="info_section" class="m-3 p-3 border rounded">    
        <div class="row">
            <div class="col-md-3">
                <img class="movie-img rounded" src="{{ movie.image }}" alt="Movie image cap" style="border: 2px solid #263238; width: 100%; height: auto;">
            </div>
            <div class="col-md-9">
                <h4 class="mt-3">{{ movie.name }}</h4>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <table class="table table-striped" style="font-size: 13px;">                
                            <tr>
                                <th>Genres</th>
                                <td>
                                    {% for genre in movie.genre.all %}
                                    {{ genre.name }} |
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th>Release</th>
                                <td>{{ movie.release_date }}</td>
                            </tr>
                            <tr>
                                <th>Running time</th>
                                <td>{{ movie.runningtime }}</td>
                            </tr>
                            <tr>
                                <th>IMDB Rating</th>
                                <td>{{ movie.rating }}</td>
                            </tr>                                                       
                        </table> 
                    </div>
                    <div class="col-md-6">
                        <table class="table table-striped" style="font-size: 13px;">      
                            <tr>
                                <th>Production</th>
                                <td>
                                    
                                </td>
                            </tr>          
                            <tr>
                                <th>Director</th>
                                <td>
                                    {% for director in movie.director.all %}
                                    <a href="{% url 'artistdetail' director.pk %}">
                                        {{ director.name }}  
                                    </a>
                                    {% endfor %}
                                </td>
                            </tr>
                            <tr>
                                <th>Writer</th>
                                <td>
                                    
                                </td>
                            </tr>
                            <tr>
                                <th>Cast crew</th>
                                <td>
                                    {% for actor in movie.cast.all %}
                                    <a href="{% url 'artistdetail' actor.pk %}">
                                        {{ actor.name }}  
                                    </a>
                                    {% endfor %}
                                </td>
                            </tr>                          
                        </table> 
                    </div>
                </div>                       
            </div>
        </div>
    </div>
    <div id="about_section" class="m-3 p-3 border rounded">     
        <div class="row">
            <div class="col-md-6">
                <h5>Plot:</h5>        
                <p>{{ movie.plot }}</p>
            </div>
            <div class="col-md-6">
                <h5>Trailer:</h5>        
                <iframe width="100%" height="240" src="https://www.youtube.com/embed/LoebZZ8K5N0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </div>       
    </div>
    <div id="action_section" class="m-3 border rounded d-flex flex-column flex-md-row justify-content-around text-center">   
        {% if profile is None %}
        <a href="{% url 'account_login' %}" id="like" class="w-100" data-toggle="tooltip" data-placement="top" title="Add to favorite list">
            <i id="icon-like" class="{% if movie|is_liked:profile %}fa fa-thumbs-up{% else %}fa fa-thumbs-o-up{% endif %}"></i>
            <span id="count-like">{{ total_likes }}</span>
            <p class="m-0">Like</p>
        </a>
        <a href="{% url 'account_login' %}" id="watched" class="w-100" data-toggle="tooltip" data-placement="top" title="Add to watched list">
            <i id="icon-watched" class="{% if movie|is_watched:profile %}fa fa-check-circle{% else %}fa fa-check-circle-o{% endif %}"></i>
            <span id="count-watched">{{ total_watched }}</span>
            <p class="m-0">Watched list</p>
        </a>
        <a href="{% url 'account_login' %}" id="watchlist" class="w-100" data-toggle="tooltip" data-placement="top" title="Add to watchlist">
            <i id="icon-watchlist" class="{% if movie|is_added:profile %}fa fa-plus-square{% else %}fa fa-plus-square-o{% endif %}"></i>
            <span id="count-watchlist">{{ total_watchlist }}</span>
            <p class="m-0">Watchlist</p>
        </a>
        <a href="{% url 'account_login' %}" id="rating" class="w-100" data-toggle="tooltip" data-placement="top" title="Give a rating">
            <i class="fa fa-star-o"></i>
            <span id="average-rating">{{ movie.rating }}</span>
            <p class="m-0">Rating</p>
        </a>
        <a href="{% url 'account_login' %}" id="comment" class="w-100" data-toggle="tooltip" data-placement="top" title="Write a comment">
            <i class="fa fa-comment-o"></i>
            <span id="count-comment">4</span>
            <p class="m-0">Comment</p>
        </a>
        {% else %}                        
        <div id="like" class="w-100" data-toggle="tooltip" data-placement="top" title="{% if movie|is_liked:profile %}Remove from favorite list{% else %}Add to favorite list{% endif %}" data-id="{{ movie.id }}">
            <i id="icon-like" class="{% if movie|is_liked:profile %}fa fa-thumbs-up{% else %}fa fa-thumbs-o-up{% endif %}"></i>
            <span id="count-like">{{ total_likes }}</span>
            <p class="m-0">Like</p>
        </div>
        <div id="watched" class="w-100" data-toggle="tooltip" data-placement="top" title="{% if movie|is_watched:profile %}Remove from watched list{% else %}Add to watched list{% endif %}" data-id="{{ movie.id }}">
            <i id="icon-watched" class="{% if movie|is_watched:profile %}fa fa-check-circle{% else %}fa fa-check-circle-o{% endif %}"></i>
            <span id="count-watched">{{ total_watched }}</span>
            <p class="m-0">Watched list</p>
        </div>
        <div id="watchlist" class="w-100" data-toggle="tooltip" data-placement="top" title="{% if movie|is_added:profile %}Remove from watchlist{% else %}Add to watchlist{% endif %}" data-id="{{ movie.id }}">
            <i id="icon-watchlist" class="{% if movie|is_added:profile %}fa fa-plus-square{% else %}fa fa-plus-square-o{% endif %}"></i>
            <span id="count-watchlist">{{ total_watchlist }}</span>
            <p class="m-0">Watchlist</p>
        </div>
        <div id="rating" class="w-100" data-toggle="tooltip" data-placement="top" title="Give a rating">
            <i class="fa fa-star-o"></i>
            <span id="average-rating">{{ movie.rating }}</span>
            <p class="m-0">Rating</p>
        </div>
        <div id="comment" class="w-100" data-toggle="tooltip" data-placement="top" title="Write a comment">
            <i class="fa fa-comment-o"></i>
            <span id="count-comment">{{ comments.count }}</span>
            <p class="m-0">Comment</p>
        </div>
        {% endif %}
    </div>
    <div id="comment_section" class="m-3 p-3 border rounded">
        <div class="row px-3 top">
            <div class="col-4 col-md-2">                
                <span id="commentscount">{{ comments.count }} comments</span>                
            </div>            
            <div class="col-4 col-md-2">
                <span>{{ movie.views }} views</span>
            </div>
            <div class="col-4 col-md-8 text-md-right">
                <div class="dropdown">
                    <button type="button" class="dropdown-toggle border-0 bg-transparent" data-toggle="dropdown">
                        <span>Sort By</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">Top comments</a>
                        <a href="#" class="dropdown-item">Newest first</a>
                    </div>
                </div>
            </div>
        </div>
        <hr />        
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="row">
                    <div class="col-md-2 text-center">
                        <img src="https://toppng.com/uploads/preview/app-icon-set-login-icon-comments-avatar-icon-11553436380yill0nchdm.png" alt="profile_picture" class="card-img">                        
                    </div>
                    <div class="col-md-10">         
                        <form id="formcomment" action="." class="was-invalidated" method="GET">
                            {% csrf_token %}
                            <div class="form-group">                                                                      
                                <textarea class="form-control" rows="3" id="textcomment" placeholder="Write a comment..." name="textcomment" required></textarea>
                            </div>
                            <div id="commentbuttons" class="form-group d-flex justify-content-end mb-0">
                                {% if profile is None %}
                                <a href="{% url 'account_login' %}" class="btn btn-primary mr-2">Comment</a>
                                {% else %}
                                <button type="submit" class="btn btn-primary mr-2">Comment</button>                        
                                {% endif %}
                                <button id="cancel" class="btn btn-danger">Cancel</button>
                            </div>
                        </form>           
                    </div>                        
                </div>
            </div>
        </div>
        <div id="allcomments">
            {% for comment in comments %}
            <div class="card mb-2">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-md-2 text-center">
                            <img src="https://toppng.com/uploads/preview/app-icon-set-login-icon-comments-avatar-icon-11553436380yill0nchdm.png" alt="profile_picture" class="card-img">
                        </div>
                        <div class="col-md-10">
                            <div class="row mb-3">
                                <div class="col-4 col-md-6">
                                    <strong class="comment_username text-muted">{{ comment.user.username }}</strong>
                                </div>
                                <div class="col-8 col-md-6 text-right">
                                    <small class="comment_datetime text-muted">
                                        {{ comment.updated_at|naturaltime }}
                                    </small>
                                </div>
                            </div>
                            <small class="comment_text">{{ comment.text_comment }}</small>
                            <div class="commentactions d-flex justify-content-start">
                                <div class="like" title="Like">
                                    <i class="fa fa-chevron-up"></i> 0
                                </div>
                                <div class="dislike" title="Dislike">
                                    <i class="fa fa-chevron-down"></i> 0
                                </div>
                                <div class="reply" title="Reply">
                                    <i class="fa fa-reply"></i> 0
                                </div>
                            </div>
                        </div>                    
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>        
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();   
    });

    $('#like').click(function () {                
        var id = $(this).attr("data-id");       
        $.ajax({
            type: "GET",
            url: "/likemovie/",
            data: {
                movie_id: id
            },
            success: function(data)
            {
                var text = $('#count-like').text();
                var count = parseInt(text);
                if (data.is_liked) {
                    $("#like").attr('title', 'Remove from favorite list');                    
                    $("#icon-like").attr("class", "fa fa-thumbs-up");
                    $("#count-like").text((count + 1).toString());
                }
                else
                {
                    $("#like").attr('title', 'Add to favorite list');                          
                    $("#icon-like").attr("class", "fa fa-thumbs-o-up");
                    $("#count-like").text((count - 1).toString());
                }
            }
        })
    });

    $('#watched').click(function () {                
        var id = $(this).attr("data-id");       
        $.ajax({
            type: "GET",
            url: "/addtowatched/",
            data: {
                movie_id: id
            },
            success: function(data)
            {
                var text = $('#count-watched').text();
                var count = parseInt(text);
                if (data.is_watched) {
                    $("#watched").attr('title', 'Remove from watched list');                    
                    $("#icon-watched").attr("class", "fa fa-check-circle");
                    $("#count-watched").text((count + 1).toString());
                }
                else
                {
                    $("#watched").attr('title', 'Add to watched list');                          
                    $("#icon-watched").attr("class", "fa fa-check-circle-o");
                    $("#count-watched").text((count - 1).toString());
                }
            }
        })
    });

    $('#watchlist').click(function () {                
        var id = $(this).attr("data-id");       
        $.ajax({
            type: "GET",
            url: "/addtowatchlist/",
            data: {
                movie_id: id
            },
            success: function(data)
            {
                var text = $('#count-watchlist').text();
                var count = parseInt(text);
                if (data.is_added) {
                    $("#watchlist").attr('title', 'Remove from watchlist');                    
                    $("#icon-watchlist").attr("class", "fa fa-plus-square");
                    $("#count-watchlist").text((count + 1).toString());
                }
                else
                {
                    $("#watchlist").attr('title', 'Add to watchlist');                          
                    $("#icon-watchlist").attr("class", "fa fa-plus-square-o");
                    $("#count-watchlist").text((count - 1).toString());
                }
            }
        })
    });

    $('#comment').click(function () {
        $('#textcomment').focus();
    });

    $('#formcomment').submit(function(e) {
        e.preventDefault();
        var movie_id = $('#like').attr("data-id");
        var textcomment = $('#textcomment').val();
        $.ajax({
            type: "GET",
            url: "/postcomment/",
            data: {
                movie_id: movie_id,
                textcomment: textcomment
            },
            success: function(data)
            {
                $('#textcomment').val("");
                $('#count-comment').text(data.count_comments);
                $('#commentscount').text(data.count_comments + " comments");
                var x = window.matchMedia("(max-width: 576px)");
                if (x.matches) {
                    $('#allcomments').prepend(
                    '<div class="card mb-2">' +
                        '<div class="card-body p-3">' +
                            '<div class="row">' +
                                '<div class="col-12">' +
                                    '<div class="row mb-3">' +
                                        '<div class="col-6">' +
                                            '<strong class="text-muted" style="font-size: 12px;">' + data.username + '</strong>' +
                                        '</div>' +
                                        '<div class="col-6 text-right">' +
                                            '<small class="text-muted" style="font-size: 11px;"> Just now </small>' +
                                        '</div>' +
                                    '</div>' +
                                    '<small style="font-size: 12px;">' + data.textcomment + '</small>' +
                                    '<div class="commentactions d-flex justify-content-start">' +
                                        '<div class="like" style="cursor: pointer; padding: 3px; width: 40px;" title="Like">' +
                                            '<i class="fa fa-chevron-up" style="font-size: 12px;"></i> 0' +
                                        '</div>' +
                                        '<div class="dislike" style="cursor: pointer; padding: 3px; width: 40px;" title="Dislike">' +
                                            '<i class="fa fa-chevron-down" style="font-size: 12px;"></i> 0' +
                                        '</div>' +
                                        '<div class="reply" style="cursor: pointer; padding: 3px; width: 40px;" title="Reply">' +
                                            '<i class="fa fa-reply" style="font-size: 12px;"></i> 0' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +             
                            '</div>' +
                        '</div>' +
                    '</div>'                   
                    )
                }
                else {                                   
                    $('#allcomments').prepend(
                    '<div class="card mb-2">' +
                        '<div class="card-body p-3">' +
                            '<div class="row">' +
                                '<div class="col-md-2 text-center">' +
                                    '<img src="https://toppng.com/uploads/preview/app-icon-set-login-icon-comments-avatar-icon-11553436380yill0nchdm.png" alt="profile_picture" class="card-img">' +
                                '</div>' +
                                '<div class="col-md-10">' +
                                    '<div class="row mb-3">' +
                                        '<div class="col-6">' +
                                            '<strong class="text-muted">' + data.username + '</strong>' +
                                        '</div>' +
                                        '<div class="col-6 text-right">' +
                                            '<small class="text-muted"> Just now </small>' +
                                        '</div>' +
                                    '</div>' +
                                    '<small>' + data.textcomment + '</small>' +
                                    '<div class="commentactions d-flex justify-content-start">' +
                                        '<div class="like" style="cursor: pointer; padding: 3px; width: 75px;" title="Like">' +
                                            '<i class="fa fa-chevron-up" style="font-size: 18px;"></i> 0' +
                                        '</div>' +
                                        '<div class="dislike" style="cursor: pointer; padding: 3px; width: 75px;" title="Dislike">' +
                                            '<i class="fa fa-chevron-down" style="font-size: 18px;"></i> 0' +
                                        '</div>' +
                                        '<div class="reply" style="cursor: pointer; padding: 3px; width: 75px;" title="Reply">' +
                                            '<i class="fa fa-reply" style="font-size: 18px;"></i> 0' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +             
                            '</div>' +
                        '</div>' +
                    '</div>'                   
                    )
                }
            }
        })
    });

    $('#cancel').click(function(e) {
        e.preventDefault();
        $('#textcomment').val("");
    });
</script>
{% endblock %}